name: Accessibility Check

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read
  security-events: write
  pull-requests: write
  issues: write

jobs:
  a11y-static:
    name: Static Accessibility Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout test-app
        uses: actions/checkout@v4

      - name: Checkout A11yInspect
        uses: actions/checkout@v4
        with:
          repository: barrierbreak/vscode-scally
          path: .a11yinspect
          ref: main

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Build A11yInspect CLI
        run: |
          cd .a11yinspect
          npm install
          npm run compile

      - name: Run A11yInspect (SARIF)
        run: |
          node .a11yinspect/out/cli/index.js \
            --format=sarif \
            --output=a11y-report.sarif \
            --severity=notice \
            --fail-on=error \
            --github \
            --github-annotations \
            "src/**/*.{html,jsx,js}"
        env:
          GITHUB_TOKEN: ${{ secrets.vscode-scally }}

      - name: Run A11yInspect (JSON)
        if: always()
        run: |
          node .a11yinspect/out/cli/index.js \
            --format=json \
            --output=a11y-report.json \
            --severity=notice \
            --fail-on=none \
            "src/**/*.{html,jsx,js}"

      - name: Run A11yInspect (HTML)
        if: always()
        run: |
          node .a11yinspect/out/cli/index.js \
            --format=html \
            --output=a11y-report.html \
            --severity=notice \
            --fail-on=none \
            "src/**/*.{html,jsx,js}"

      - name: Upload SARIF to GitHub Security
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: a11y-report.sarif

      - name: Upload Report Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: a11y-reports
          path: |
            a11y-report.sarif
            a11y-report.json
            a11y-report.html
          retention-days: 30